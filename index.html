<script>
  window.onload = function () {
    // === FUNGSI HITUNG BBFS ===
    function generateBBFSFromLast10(results) {
      if (results.length !== 10) {
        throw new Error("Harus 10 keluaran terakhir 4D!");
      }

      const frequency = Array(10).fill(0);

      results.forEach(num => {
        if (num.length !== 4) throw new Error("Format keluaran harus 4 digit");
        num.split('').forEach(digit => {
          frequency[parseInt(digit)]++;
        });
      });

      const freqWithDigit = frequency.map((count, digit) => ({ digit, count }));
      const sorted = [...freqWithDigit].sort((a, b) => b.count - a.count);

      const mostFrequent = sorted.slice(0, 3).map(item => item.digit.toString());
      const leastFrequent = sorted.slice(-3).map(item => item.digit.toString());

      const bbfsPool = [...new Set([...mostFrequent, ...leastFrequent])];

      if (bbfsPool.length < 6) {
        const allDigits = [...Array(10).keys()].map(n => n.toString());
        const extra = allDigits.filter(d => !bbfsPool.includes(d));
        while (bbfsPool.length < 6 && extra.length > 0) {
          const rand = extra.splice(Math.floor(Math.random() * extra.length), 1)[0];
          bbfsPool.push(rand);
        }
      }

      function getRandomCombination(arr, length) {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, length);
      }

      const combinations4D = Array.from({ length: 5 }, () => getRandomCombination(bbfsPool, 4).join(''));
      const derived3D = combinations4D.map(item => item.slice(0, 3));
      const derived2D = combinations4D.map(item => item.slice(-2));

      return {
        bbfs: bbfsPool.join(''),
        kombinasi4D: combinations4D,
        kombinasi3D: derived3D,
        kombinasi2D: derived2D
      };
    }

    // === AMBIL ELEMEN DOM ===
    const tombol = document.querySelector('button');
    const hasil = document.getElementById('hasil');
    const progressWrapper = document.getElementById('progressWrapper');
    const progressBar = document.getElementById('progressBar');

    // === EVENT SAAT TOMBOL DIKLIK ===
    tombol.addEventListener('click', function () {
      const input = document.getElementById('inputAngka').value;
      const angkaArray = input.split(',').map(a => a.trim()).filter(a => a.length === 4);

      if (angkaArray.length !== 10) {
        alert('Masukkan tepat 10 angka 4D.');
        return;
      }

      // Reset hasil
      hasil.innerHTML = `<p style="font-style:italic; color:#444;">â³ Memproses angka, harap tunggu...</p>`;
      hasil.style.display = 'block';
      progressWrapper.style.display = 'block';
      progressBar.style.width = '0%';
      tombol.disabled = true;
      tombol.innerText = "ğŸ”„ Sedang memproses...";

      // Jalankan progress bar
      let duration = 15000; // 15 detik
      let interval = 100;
      let progress = 0;
      let steps = duration / interval;
      let increment = 100 / steps;

      let progressInterval = setInterval(() => {
        progress += increment;
        progressBar.style.width = `${Math.min(progress, 100)}%`;
      }, interval);

      setTimeout(() => {
        clearInterval(progressInterval);

        try {
          const hasilPrediksi = generateBBFSFromLast10(angkaArray);

          hasil.innerHTML = `<p>ğŸ¯ <strong>BBFS (6 angka):</strong> ${hasilPrediksi.bbfs}</p>`;

          setTimeout(() => {
            hasil.innerHTML += `<p>ğŸ° <strong>Kombinasi 4D (acak):</strong><br> ${hasilPrediksi.kombinasi4D.join(', ')}</p>`;
          }, 1000);

          setTimeout(() => {
            hasil.innerHTML += `<p>ğŸ”¢ <strong>3D dari 4D:</strong><br> ${hasilPrediksi.kombinasi3D.join(', ')}</p>`;
          }, 2000);

          setTimeout(() => {
            hasil.innerHTML += `<p>ğŸ¯ <strong>2D dari 4D:</strong><br> ${hasilPrediksi.kombinasi2D.join(', ')}</p>`;
          }, 3000);
        } catch (err) {
          hasil.innerHTML = `<p style="color:red;">âŒ ${err.message}</p>`;
        }

        tombol.disabled = false;
        tombol.innerText = "ğŸ¯ Prediksi Sekarang";
        progressWrapper.style.display = 'none';
        progressBar.style.width = '0%';
      }, duration);
    });
  };
</script>
<div id="progressWrapper" style="display:none; margin-top: 1rem;">
  <div style="height: 10px; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
    <div id="progressBar" style="height: 100%; width: 0%; background: #2563eb; transition: width 0.2s;"></div>
  </div>
</div>
